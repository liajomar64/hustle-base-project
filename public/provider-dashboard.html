<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Dashboard - HustleBase</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html"><h1>HustleBase</h1></a>
            </div>
            <div class="nav-links">
                <a href="browse.html">Browse</a>
                <a href="profile.html" class="active">My Profile</a>
                <a href="provider-dashboard.html" class="active">Dashboard</a>
                <button class="btn btn-outline" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container dashboard">
        <div class="dashboard-header">
            <h1>Provider Dashboard</h1>
            <p>Manage your services and track your performance</p>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3><span class="dashboard-card-icon"><i class="fas fa-eye"></i></span> Profile Views</h3>
                <div class="dashboard-stat" id="profileViews">-</div>
                <div class="dashboard-stat-label">Total views this month</div>
            </div>

            <div class="dashboard-card">
                <h3><span class="dashboard-card-icon"><i class="fas fa-star"></i></span> Average Rating</h3>
                <div class="dashboard-stat" id="avgRating">-</div>
                <div class="dashboard-stat-label">Based on <span id="reviewCount">0</span> reviews</div>
            </div>

            <div class="dashboard-card">
                <h3><span class="dashboard-card-icon"><i class="fas fa-comments"></i></span> Total Reviews</h3>
                <div class="dashboard-stat" id="totalReviews">0</div>
                <div class="dashboard-stat-label">Customer feedback</div>
            </div>

            <div class="dashboard-card">
                <h3><span class="dashboard-card-icon"><i class="fas fa-clipboard-check"></i></span> Profile Status</h3>
                <div class="dashboard-stat" id="profileStatus" style="font-size: 1.25rem;">-</div>
                <div class="dashboard-stat-label">Your profile visibility</div>
            </div>
        </div>

        <div class="dashboard-actions">
            <a href="browse-requests.html" class="btn btn-primary"><i class="fas fa-briefcase"></i> Browse Job Requests</a>
            <a href="profile.html" class="btn btn-secondary">Edit Profile</a>
            <a href="browse.html" class="btn btn-outline">View Public Directory</a>
        </div>

        <!-- My Applications -->
        <div class="dashboard-card" style="margin-top: 2rem;">
            <h3><span class="dashboard-card-icon"><i class="fas fa-paper-plane"></i></span> My Job Applications</h3>
            <div id="myApplications" style="margin-top: 1.5rem;">
                <p class="loading">Loading your applications...</p>
            </div>
        </div>

        <!-- Recent Reviews -->
        <div class="dashboard-card" style="margin-top: 2rem;">
            <h3><span class="dashboard-card-icon"><i class="fas fa-file-alt"></i></span> Recent Reviews</h3>
            <div id="recentReviews" style="margin-top: 1.5rem;">
                <p class="loading">Loading reviews...</p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        checkAuthStatus().then(() => {
            loadProviderDashboard();
        });

        async function loadProviderDashboard() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is provider
            const userRole = user.user_metadata?.role || await getUserRole(user.id);
            if (userRole !== 'provider') {
                window.location.href = 'client-dashboard.html';
                return;
            }

            const client = getSupabaseClient();

            // Load provider stats
            const { data: providerData } = await client
                .from('providers')
                .select('id')
                .eq('user_id', user.id)
                .single();
            
            const provider = providerData;

            if (provider) {
                document.getElementById('profileStatus').textContent = 'Active';
                document.getElementById('profileStatus').style.color = 'var(--success)';
            } else {
                document.getElementById('profileStatus').textContent = 'Not Created';
                document.getElementById('profileStatus').style.color = 'var(--warning)';
            }

            // Load reviews
            const { data: reviews } = await client
                .from('reviews')
                .select('*')
                .eq('provider_id', user.id)
                .order('created_at', { ascending: false })
                .limit(5);
            
            const reviewsList = reviews || [];

            // Load user info for reviews
            if (reviewsList && reviewsList.length > 0) {
                const clientIds = [...new Set(reviewsList.map(r => r.client_id))];
                const { data: reviewUsers } = await client
                    .from('users')
                    .select('id, name')
                    .in('id', clientIds);

                const userMap = {};
                if (reviewUsers) {
                    reviewUsers.forEach(u => {
                        userMap[u.id] = u;
                    });
                }
                reviewsList.forEach(review => {
                    review.users = userMap[review.client_id];
                });
            }

            if (reviewsList && reviewsList.length > 0) {
                const avgRating = reviewsList.reduce((sum, r) => sum + r.rating, 0) / reviewsList.length;
                document.getElementById('avgRating').textContent = avgRating.toFixed(1);
                document.getElementById('reviewCount').textContent = reviewsList.length;
                document.getElementById('totalReviews').textContent = reviewsList.length;

                // Display recent reviews
                const reviewsHtml = reviewsList.map(review => `
                    <div class="review-item" style="margin-bottom: 1rem;">
                        <div class="review-header">
                            <span class="review-author">${review.users?.name || 'Anonymous'}</span>
                            <span class="stars">${'‚≠ê'.repeat(review.rating)}</span>
                        </div>
                        <p class="review-comment">${review.comment || 'No comment'}</p>
                        <small style="color: var(--text-secondary);">${new Date(review.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
                document.getElementById('recentReviews').innerHTML = reviewsHtml;
            } else {
                document.getElementById('recentReviews').innerHTML = '<p style="color: var(--text-secondary);">No reviews yet. Keep providing great service!</p>';
            }

            // Profile views (placeholder - would need analytics)
            document.getElementById('profileViews').textContent = '0';

            // Load job applications
            const { data: applications } = await client
                .from('job_applications')
                .select(`
                    *,
                    job_requests:job_request_id (
                        title,
                        description,
                        category,
                        budget,
                        status
                    )
                `)
                .eq('provider_id', user.id)
                .order('created_at', { ascending: false })
                .limit(10);
            
            const applicationsList = applications || [];

            if (applicationsList && applicationsList.length > 0) {
                const applicationsHtml = applicationsList.map(app => {
                    const statusColor = app.status === 'accepted' ? 'var(--success)' : 
                                       app.status === 'pending' ? 'var(--warning)' : 
                                       'var(--danger)';
                    return `
                        <div class="review-item" style="margin-bottom: 1rem;">
                            <div class="review-header">
                                <span class="review-author">${app.job_requests?.title || 'Job Request'}</span>
                                <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; text-transform: capitalize;">${app.status}</span>
                            </div>
                            <p class="review-comment">${app.message || 'No message'}</p>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                <span><i class="fas fa-tag"></i> ${app.job_requests?.category || 'N/A'}</span>
                                ${app.proposed_price ? `<span><i class="fas fa-dollar-sign"></i> ${app.proposed_price}</span>` : ''}
                                <span><i class="fas fa-calendar"></i> ${new Date(app.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('myApplications').innerHTML = applicationsHtml;
            } else {
                document.getElementById('myApplications').innerHTML = '<p style="color: var(--text-secondary);">You haven\'t applied to any jobs yet. <a href="browse-requests.html" style="color: var(--primary);">Browse available requests!</a></p>';
            }
        }
    </script>
</body>
</html>

